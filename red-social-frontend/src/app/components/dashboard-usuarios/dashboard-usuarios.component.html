<div class="dashboard-usuarios">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-users me-2"></i>Gestión de Usuarios</h2>
      <button class="btn btn-primary" (click)="toggleFormulario()">
        <i class="fas" [class.fa-plus]="!mostrarFormulario" [class.fa-times]="mostrarFormulario"></i>
        {{ mostrarFormulario ? 'Cancelar' : 'Crear Usuario' }}
      </button>
    </div>

    <!-- Alertas -->
    <div class="alert alert-danger alert-dismissible fade show" role="alert" *ngIf="error">
      {{ error }}
      <button type="button" class="btn-close" (click)="cerrarAlerta()"></button>
    </div>

    <div class="alert alert-success alert-dismissible fade show" role="alert" *ngIf="exitoMensaje">
      {{ exitoMensaje }}
      <button type="button" class="btn-close" (click)="cerrarAlerta()"></button>
    </div>

    <!-- Formulario de creación -->
    <div class="card mb-4" *ngIf="mostrarFormulario">
      <div class="card-header">
        <h5 class="mb-0">Crear Nuevo Usuario</h5>
      </div>
      <div class="card-body">
        <form (ngSubmit)="crearUsuario()">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre *</label>
              <input type="text" class="form-control" [(ngModel)]="nuevoUsuario.nombre" name="nombre" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Apellido *</label>
              <input type="text" class="form-control" [(ngModel)]="nuevoUsuario.apellido" name="apellido" required>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Correo Electrónico *</label>
              <input type="email" class="form-control" [(ngModel)]="nuevoUsuario.correo" name="correo" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Nombre de Usuario *</label>
              <input type="text" class="form-control" [(ngModel)]="nuevoUsuario.nombreUsuario" name="nombreUsuario" required>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Contraseña *</label>
              <input type="password" class="form-control" [(ngModel)]="nuevoUsuario.password" name="password" required>
              <small class="text-muted">Mínimo 8 caracteres, una mayúscula y un número</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Fecha de Nacimiento *</label>
              <input type="date" class="form-control" [(ngModel)]="nuevoUsuario.fechaNacimiento" name="fechaNacimiento" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Descripción Breve *</label>
            <textarea class="form-control" [(ngModel)]="nuevoUsuario.descripcionBreve" name="descripcionBreve" rows="3" maxlength="200" required></textarea>
            <small class="text-muted">{{ nuevoUsuario.descripcionBreve.length }}/200 caracteres</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Rol *</label>
            <select class="form-select" [(ngModel)]="nuevoUsuario.perfil" name="perfil" required>
              <option value="usuario">Usuario</option>
              <option value="administrador">Administrador</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary" [disabled]="cargando">
            <span *ngIf="cargando" class="spinner-border spinner-border-sm me-2"></span>
            Crear Usuario
          </button>
        </form>
      </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Lista de Usuarios ({{ usuarios.length }})</h5>
      </div>
      <div class="card-body">
        <div class="text-center py-4" *ngIf="cargando">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <div class="table-responsive" *ngIf="!cargando">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Fecha Registro</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let usuario of usuarios">
                <td>
                  <div class="d-flex align-items-center">
                    <img 
                      [src]="usuario.imagenPerfil || 'https://ui-avatars.com/api/?name=' + usuario.nombreUsuario.charAt(0)" 
                      class="rounded-circle me-2" 
                      width="40" 
                      height="40"
                      [alt]="usuario.nombreUsuario">
                    <strong>{{ usuario.nombreUsuario }}</strong>
                  </div>
                </td>
                <td>{{ usuario.nombre }} {{ usuario.apellido }}</td>
                <td>{{ usuario.correo }}</td>
                <td>
                  <span class="badge" [class.bg-danger]="usuario.perfil === 'administrador'" [class.bg-secondary]="usuario.perfil === 'usuario'">
                    {{ usuario.perfil === 'administrador' ? 'Admin' : 'Usuario' }}
                  </span>
                </td>
                <td>
                  <span class="badge" [class.bg-success]="usuario.activo" [class.bg-warning]="!usuario.activo">
                    {{ usuario.activo ? 'Activo' : 'Inactivo' }}
                  </span>
                </td>
                <td>{{ usuario.fechaRegistro | date:'short' }}</td>
                <td>
                  <div class="btn-group" role="group">
                    <button 
                      class="btn btn-sm btn-primary"
                      (click)="verPublicaciones(usuario)"
                      title="Ver publicaciones">
                      <i class="fas fa-list"></i>
                    </button>
                    <button 
                      *ngIf="usuario.activo" 
                      class="btn btn-sm btn-warning"
                      (click)="desactivarUsuario(usuario._id)"
                      title="Desactivar usuario">
                      <i class="fas fa-ban"></i>
                    </button>
                    <button 
                      *ngIf="!usuario.activo" 
                      class="btn btn-sm btn-success"
                      (click)="activarUsuario(usuario._id)"
                      title="Activar usuario">
                      <i class="fas fa-check"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para desactivar -->
<div class="modal fade" [class.show]="mostrarModalDesactivar" [style.display]="mostrarModalDesactivar ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Desactivación</h5>
        <button type="button" class="btn-close" (click)="cerrarModalDesactivar()"></button>
      </div>
      <div class="modal-body">
        <div class="text-center py-3">
          <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
          <h5 class="mt-3">¿Está seguro de desactivar este usuario?</h5>
          <p class="text-muted">Esta acción se puede revertir posteriormente activando el usuario nuevamente.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalDesactivar()">
          Cancelar
        </button>
        <button type="button" class="btn btn-warning" (click)="confirmarDesactivar()">
          <i class="fas fa-ban me-2"></i>Desactivar
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="mostrarModalDesactivar" *ngIf="mostrarModalDesactivar"></div>

<!-- Modal de publicaciones del usuario -->
<div class="modal fade" [class.show]="mostrarModalPublicaciones" [style.display]="mostrarModalPublicaciones ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-images me-2"></i>
          Publicaciones de {{ usuarioSeleccionado?.nombreUsuario }}
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModalPublicaciones()"></button>
      </div>
      <div class="modal-body">
        <div class="text-center py-4" *ngIf="cargandoPublicaciones">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando publicaciones...</span>
          </div>
        </div>

        <div *ngIf="!cargandoPublicaciones && publicacionesUsuario.length === 0" class="text-center py-5">
          <i class="fas fa-inbox text-muted" style="font-size: 3rem;"></i>
          <p class="text-muted mt-3">Este usuario no tiene publicaciones</p>
        </div>

        <div *ngIf="!cargandoPublicaciones && publicacionesUsuario.length > 0" class="row">
          <div class="col-md-6 mb-3" *ngFor="let publicacion of publicacionesUsuario">
            <div class="card h-100">
              <img 
                *ngIf="publicacion.imagen" 
                [src]="publicacion.imagen" 
                class="card-img-top publicacion-imagen" 
                [alt]="publicacion.titulo || publicacion.contenido">
              <div class="card-body">
                <h6 class="card-title" *ngIf="publicacion.titulo">{{ publicacion.titulo }}</h6>
                <p class="card-text">{{ publicacion.contenido }}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    <i class="fas fa-heart me-1"></i>{{ publicacion.likes?.length || 0 }}
                    <i class="fas fa-comment ms-3 me-1"></i>{{ publicacion.comentarios?.length || 0 }}
                  </small>
                  <small class="text-muted">{{ publicacion.fechaCreacion | date:'short' }}</small>
                </div>
              </div>
              <div class="card-footer bg-white border-top-0">
                <button 
                  class="btn btn-sm btn-danger w-100"
                  (click)="eliminarPublicacion(publicacion._id)">
                  <i class="fas fa-trash me-2"></i>Eliminar Publicación
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalPublicaciones()">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="mostrarModalPublicaciones" *ngIf="mostrarModalPublicaciones"></div>
